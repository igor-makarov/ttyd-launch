#!/bin/bash

ACTION=""
while [ $# -gt 0 ]; do
    case "$1" in
        --host)
            if [ -z "$2" ]; then
                echo "Error: --host requires a value (localhost, mdns, or hostname)"
                exit 1
            fi
            export TTYD_LAUNCH_HOST="$2"
            shift 2
            ;;
        --port)
            if [ -z "$2" ]; then
                echo "Error: --port requires a value"
                exit 1
            fi
            export TTYD_LAUNCH_PORT="$2"
            shift 2
            ;;
        --stop)
            ACTION="stop"
            shift
            ;;
        --list)
            ACTION="list"
            shift
            ;;
        *)
            break
            ;;
    esac
done

base_url() {
    local host_setting="${TTYD_LAUNCH_HOST:-localhost}"
    local port=""
    local protocol="https"
    local host="$host_setting"

    if [ "$host_setting" = "localhost" ]; then
        protocol="http"
        port="${TTYD_LAUNCH_PORT:-7681}"
    elif [ "$host_setting" = "mdns" ]; then
        protocol="http"
        host="$(hostname).local"
        port="${TTYD_LAUNCH_PORT:-7681}"
    else
        port="${TTYD_LAUNCH_PORT}"
    fi

    if [ -n "$port" ]; then
        echo "${protocol}://${host}:${port}/"
    else
        echo "${protocol}://${host}/"
    fi
}

session_url() {
    echo "$(base_url)?arg=attach-session&arg=-t&arg=$1"
}

if [ "$ACTION" = "stop" ]; then
    pkill -x ttyd && echo "ttyd stopped" || echo "ttyd is not running"
    exit 0
fi

if [ "$ACTION" = "list" ]; then
    tmux ls -F '#{session_name}' 2>/dev/null | while read -r session; do
        echo "$session: $(session_url "$session")"
    done
    exit 0
fi

if [ $# -eq 0 ] && [ -z "$ACTION" ]; then
    echo "Usage: ttyd-launch [--host <host>] <command> [args...]"
    echo "       ttyd-launch [--host <host>] --list"
    echo "       ttyd-launch --stop"
    echo ""
    echo "Launches a command in a tmux session and prints a ttyd URL to connect"
    echo ""
    echo "Options:"
    echo "  --host <host>  Set hostname for URLs (localhost, mdns, or hostname)"
    echo "                 Can also be set via TTYD_LAUNCH_HOST env var"
    echo "  --port <port>  Set port (default: 7681 for localhost/mdns)"
    echo "                 Can also be set via TTYD_LAUNCH_PORT env var"
    exit 1
fi

if ! command -v tmux &> /dev/null; then
    echo "Error: tmux is not installed or not in PATH"
    exit 1
fi

PORT="${TTYD_LAUNCH_PORT:-7681}"

# Start ttyd on our port if nothing's listening there
if ! lsof -i ":$PORT" -sTCP:LISTEN &>/dev/null; then
    echo "Starting ttyd on port $PORT..."
    ttyd --writable --url-arg --port "$PORT" tmux &> /dev/null &
fi

SESSION_NAME=$(uuidgen)
URL=$(session_url "$SESSION_NAME")
CMD=$(printf '%q ' "$@")

# Create session: print URL then run command
tmux new-session -s "$SESSION_NAME" "echo 'Connect to this session via ttyd:' && echo '$URL' && $CMD"
